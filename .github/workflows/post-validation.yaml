name: Handle Post-Validation Results

"on":
  workflow_call:
    inputs:
      problems:
        required: false
        type: string
      issue-author:
        required: true
        type: string
    secrets:
      token:
        required: true
        description: GitHub token with `issues` scope

permissions:
  issues: write
  contents: read

jobs:
  post-validation:
    runs-on: ubuntu-latest

    steps:
      - name: (1) Parse inputs
        id: parse
        run: |
          echo "ğŸ§­ Step 1 â€” Parsing inputs"
          RAW_PROBLEMS='${{ inputs.problems }}'
          if [ -z "$RAW_PROBLEMS" ]; then RAW_PROBLEMS="[]"; fi
          echo "problems=$RAW_PROBLEMS" >> "$GITHUB_OUTPUT"
          echo "author=${{ inputs.issue-author }}" >> "$GITHUB_OUTPUT"

      - name: (2) Compute problem count
        id: count
        uses: actions/github-script@v7
        with:
          script: |
            const problems = JSON.parse(`${{ steps.parse.outputs.problems }}`);
            console.log(`ğŸ” Step 2 â€” Problems detected: ${problems.length}`);
            core.setOutput('count', String(problems.length));

      - name: (3) Comment â€” still failing
        if: ${{ steps.count.outputs.count != '0' }}
        uses: ./.github/actions/post-comment
        with:
          token: ${{ secrets.token }}
          body: |
            {{
              format('
              %s
              ', join(fromJSON(steps.parse.outputs.problems), '\n'))
            }}
        # The above preserves your body content via the fail list. If you want the exact original text:
        # body: |
        #   Hey @${{ steps.parse.outputs.author }}, thanks for updating your ticket! However, the following issues remain:
        #   ${{ join(fromJSON(steps.parse.outputs.problems), '\n') }}
        #   Please revise the issue again and this will recheck automatically on save.

      - name: (4) Labels â€” ensure needs-more-info
        if: ${{ steps.count.outputs.count != '0' }}
        uses: ./.github/actions/manage-labels
        with:
          token: ${{ secrets.token }}
          add: '["needs-more-info"]'

      - name: (5) Assign â€” author on failure
        if: ${{ steps.count.outputs.count != '0' }}
        uses: ./.github/actions/manage-assignees
        with:
          token: ${{ secrets.token }}
          action: add
          assignees: ${{ format('["{0}"]', steps.parse.outputs.author) }}

      - name: (6) Comment â€” passed validation
        if: ${{ steps.count.outputs.count == '0' }}
        uses: ./.github/actions/post-comment
        with:
          token: ${{ secrets.token }}
          body: |
            **Thanks @${{ steps.parse.outputs.author }}, your ticket now meets the minimum requirements!**

      - name: (7) Labels â€” swap on success
        if: ${{ steps.count.outputs.count == '0' }}
        uses: ./.github/actions/manage-labels
        with:
          token: ${{ secrets.token }}
          add: '["needs-triage"]'
          remove: '["needs-more-info"]'

      - name: (8) Unassign â€” author if present
        if: ${{ steps.count.outputs.count == '0' }}
        uses: ./.github/actions/manage-assignees
        with:
          token: ${{ secrets.token }}
          action: remove
          assignees: ${{ format('["{0}"]', steps.parse.outputs.author) }}

      - name: (9) Summary â€” failure
        if: ${{ steps.count.outputs.count != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const problems = JSON.parse(`${{ steps.parse.outputs.problems }}`);
            console.log("ğŸ“‹ Step 9 â€” Writing failure summary");
            await core.summary
              .addHeading('âŒ Post-Validation â€” Still Failing')
              .addList(problems)
              .write();

      - name: (10) Summary â€” success
        if: ${{ steps.count.outputs.count == '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const author = `${{ steps.parse.outputs.author }}`;
            console.log("ğŸ“‹ Step 10 â€” Writing success summary");
            await core.summary
              .addHeading('âœ… Post-Validation â€” Passed')
              .addRaw(`@${author}'s ticket cleared validation after edits.`)
              .write();
