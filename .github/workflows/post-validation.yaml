name: Handle Post-Validation Results

"on":
  workflow_call:
    inputs:
      problems:
        required: false
        type: string
      issue-author:
        required: true
        type: string
    secrets:
      token:
        required: true
        description: GitHub token with `issues` scope

permissions:
  issues: write
  contents: read

jobs:
  post-validation:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Parse inputs + announce start
      - name: (1) Parse inputs
        id: parse
        run: |
          echo "ğŸ§­ Step 1 â€” Parsing inputs"
          RAW_PROBLEMS='${{ inputs.problems }}'
          if [ -z "$RAW_PROBLEMS" ]; then RAW_PROBLEMS="[]"; fi
          echo "problems=$RAW_PROBLEMS" >> "$GITHUB_OUTPUT"
          echo "author=${{ inputs.issue-author }}" >> "$GITHUB_OUTPUT"

      # 2ï¸âƒ£ Decide branch (fail/success) & log counts
      - name: (2) Compute problem count
        id: count
        shell: bash
        run: |
          echo "ğŸ” Step 2 â€” Counting problems"
          python - << 'PY'
          import json, os
          problems = json.loads(os.environ.get("PROBLEMS","[]"))
          print(f"Problems detected: {len(problems)}")
          print(f"count={len(problems)}")
          PY
        env:
          PROBLEMS: ${{ steps.parse.outputs.problems }}

      # 3ï¸âƒ£ Failure branch â€” post comment (same body), label, assign
      - name: (3) Comment â€” still failing
        if: ${{ steps.count.outputs.count != '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ’¬ Step 3 â€” Posting failure comment")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const author = `${{ steps.parse.outputs.author }}`;
            const problems = JSON.parse(`${{ steps.parse.outputs.problems }}`);

            const message = [
              "",
              `Hey @${author}, thanks for updating your ticket! However, the following issues remain:`,
              problems.join('\n'),
              "",
              "Please revise the issue again and this will recheck automatically on save.",
            ].join('\n');

            await github.rest.issues.createComment({ owner, repo, issue_number, body: message });

      - name: (4) Labels â€” ensure needs-more-info
        if: ${{ steps.count.outputs.count != '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ·ï¸ Step 4 â€” Ensuring 'needs-more-info' label")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number });
            const names = labels.map(l => l.name);
            if (!names.includes('needs-more-info')) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['needs-more-info'] });
            }

      - name: (5) Assign â€” author on failure
        if: ${{ steps.count.outputs.count != '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ‘¤ Step 5 â€” Assigning author (failure)")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const author = `${{ steps.parse.outputs.author }}`;
            await github.rest.issues.addAssignees({ owner, repo, issue_number, assignees: [author] });
            console.log("ğŸŸ¥ FAIL: Validation failed. Problems were found. Label remains.");

      # 4ï¸âƒ£ Success branch â€” comment, relabel, unassign
      - name: (6) Comment â€” passed validation
        if: ${{ steps.count.outputs.count == '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ’¬ Step 6 â€” Posting success comment")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const author = `${{ steps.parse.outputs.author }}`;

            const successMessage = [
              `**Thanks @${author}, your ticket now meets the minimum requirements!**`,
            ].join('\n');

            await github.rest.issues.createComment({ owner, repo, issue_number, body: successMessage });

      - name: (7) Labels â€” remove needs-more-info, ensure needs-triage
        if: ${{ steps.count.outputs.count == '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ·ï¸ Step 7 â€” Adjusting labels for success")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number });
            const names = labels.map(l => l.name);

            if (names.includes('needs-more-info')) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name: 'needs-more-info' });
            }
            if (!names.includes('needs-triage')) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: ['needs-triage'] });
            }

      - name: (8) Unassign â€” author if present
        if: ${{ steps.count.outputs.count == '0' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            console.log("ğŸ‘¤ Step 8 â€” Unassigning author (success)")
            const { github, context } = require('@actions/github');
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const author = `${{ steps.parse.outputs.author }}`;

            const { data: current } = await github.rest.issues.get({ owner, repo, issue_number });
            const assignees = current.assignees.map(a => a.login);
            if (assignees.includes(author)) {
              await github.rest.issues.removeAssignees({ owner, repo, issue_number, assignees: [author] });
              console.log(`âœ… Removed ${author} from assignees`);
            } else {
              console.log("No removal needed â€” not assigned");
            }

      # 5ï¸âƒ£ Summaries
      - name: (9) Summary â€” failure
        if: ${{ steps.count.outputs.count != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { core } = require('@actions/github');
            const problems = JSON.parse(`${{ steps.parse.outputs.problems }}`);
            console.log("ğŸ“‹ Step 9 â€” Writing failure summary");
            await core.summary
              .addHeading('âŒ Post-Validation â€” Still Failing')
              .addList(problems)
              .write();

      - name: (10) Summary â€” success
        if: ${{ steps.count.outputs.count == '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { core } = require('@actions/github');
            const author = `${{ steps.parse.outputs.author }}`;
            console.log("ğŸ“‹ Step 10 â€” Writing success summary");
            await core.summary
              .addHeading('âœ… Post-Validation â€” Passed')
              .addRaw(`@${author}'s ticket cleared validation after edits.`)
              .write();
