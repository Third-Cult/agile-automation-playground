name: Add to Default Project

on:
  workflow_call:
    inputs:
      project-id:
        description: "Project ID to add issue to"
        required: true
        type: string
    secrets:
      token:
        description: "GitHub token with project write access"
        required: true

jobs:
  add-to-project:
    runs-on: ubuntu-latest

    steps:
      - name: Add issue to project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.token }}
          script: |
            const projectId = '${{ inputs.project-id }}';
            const issueNodeId = context.payload?.issue?.node_id;

            let summaryMessage = "";

            try {
              if (!projectId || !issueNodeId) {
                const missing = !projectId ? "projectId" : "issueNodeId";
                const errorMsg = `üö® ERROR: Missing required value: ${missing}`;
                core.setFailed(errorMsg);
                summaryMessage = errorMsg;
                return;
              }

              core.info(`‚ÑπÔ∏è INFO: Attempting to add issue node '${issueNodeId}' to project '${projectId}'`);

              const result = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId,
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, {
                projectId,
                contentId: issueNodeId
              });

              const addedId = result?.addProjectV2ItemById?.item?.id;

              if (addedId) {
                const successMsg = `‚úÖ SUCCESS: Issue added to project successfully. Item ID: ${addedId}`;
                core.info(successMsg);
                summaryMessage = successMsg;
              } else {
                const warnMsg = "‚ö†Ô∏è WARNING: Mutation succeeded but no item ID was returned.";
                core.warning(warnMsg);
                summaryMessage = warnMsg;
              }

            } catch (error) {
              const errorMsg = `üö® ERROR: Failed to add issue to project: ${error.message}`;
              core.setFailed(errorMsg);
              summaryMessage = error.message.includes('Resource not accessible by integration')
                ? errorMsg + " üîí It looks like the token does not have access to the project."
                : errorMsg;
            } finally {
              await core.summary
                .addHeading('üì¶ Project Assignment Summary')
                .addRaw(summaryMessage)
                .write();
            }
