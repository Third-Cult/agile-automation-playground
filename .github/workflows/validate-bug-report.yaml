name: Validate Bug Report
on:
  workflow_call:
    inputs:
      issue_number:
        description: 'The issue number to validate'
        required: true
        type: number
      issue_body:
        description: 'The body content of the issue'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check required fields
        id: check_fields
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ inputs.issue_body }}`;
            
            // GitHub issue forms convert field IDs to markdown headers
            // Extract content between headers
            const getFieldContent = (body, fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*\\n([\\s\\S]*?)(?=###|$)`, 'i');
              const match = body.match(regex);
              if (!match) return null;
              
              const content = match[1].trim();
              return content.length > 0 ? content : null;
            };
            
            const missingFields = [];
            
            const description = getFieldContent(body, 'Description');
            const steps = getFieldContent(body, 'Steps to Reproduce');
            const expected = getFieldContent(body, 'Expected Behavior');
            const actual = getFieldContent(body, 'Actual Behavior');
            
            if (!description) missingFields.push('Description');
            if (!steps) missingFields.push('Steps to Reproduce');
            if (!expected) missingFields.push('Expected Behavior');
            if (!actual) missingFields.push('Actual Behavior');
            
            const isValid = missingFields.length === 0;
            
            core.setOutput('is_valid', isValid);
            core.setOutput('missing_fields', missingFields.join(', '));

      - name: Post validation comment
        if: steps.check_fields.outputs.is_valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ inputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **Bug Report Validation Failed**
              
              This bug report is missing required information:
              - ${{ steps.check_fields.outputs.missing_fields }}
              
              Please update the issue with the missing fields so we can properly triage and address this bug.`
            })
            
            // Remove valid label if it exists, add needs-info label
            try {
              await github.rest.issues.removeLabel({
                issue_number: ${{ inputs.issue_number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'valid'
              })
            } catch (e) {}
            
            try {
              await github.rest.issues.addLabels({
                issue_number: ${{ inputs.issue_number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['needs-info']
              })
            } catch (e) {}

      - name: Mark as valid
        if: steps.check_fields.outputs.is_valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Remove needs-info label if it exists, add valid label
            try {
              await github.rest.issues.removeLabel({
                issue_number: ${{ inputs.issue_number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'needs-info'
              })
            } catch (e) {}
            
            try {
              await github.rest.issues.addLabels({
                issue_number: ${{ inputs.issue_number }},
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['valid']
              })
            } catch (e) {}
