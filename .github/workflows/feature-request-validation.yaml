name: Validate Feature Request Ticket

"on":
  workflow_call:
    inputs:
      quiet:
        description: "Suppress validator comments; rely on caller workflow to comment."
        required: false
        type: boolean
        default: false
    outputs:
      problems:
        description: "JSON array of validation problems"
        value: ${{ jobs.run-validation.outputs.problems }}

permissions:
  issues: write
  contents: read

jobs:
  run-validation:
    runs-on: ubuntu-latest
    outputs:
      problems: ${{ steps.validate.outputs.problems }}
    env:
      QUIET: ${{ inputs.quiet }}

    steps:
      # 1ï¸âƒ£ Init
      - name: (1) Init defaults
        id: init
        run: |
          echo "ðŸ§© Step 1 â€” Initializing default labels"
          echo 'labels_fail=["needs-more-info"]' >> "$GITHUB_OUTPUT"
          echo 'labels_pass=["needs-triage"]' >> "$GITHUB_OUTPUT"

      # 2ï¸âƒ£ Read issue data
      - name: (2) Read issue
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ðŸ“– Step 2 â€” Fetching issue body & author");
            const { github, context, core } = require('@actions/github');
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
            });
            console.log(`âž¡ï¸ Issue author: ${issue.user.login}`);
            core.setOutput('author', issue.user.login);
            core.setOutput('body', issue.body || '');

      # 3ï¸âƒ£ Validate required sections
      - name: (3) Validate content
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ðŸ” Step 3 â€” Running content validation");
            const { core } = require('@actions/github');
            const body   = `${{ steps.issue.outputs.body }}`;
            const author = `${{ steps.issue.outputs.author }}`;

            const problems = [];
            if (!/Problem Statement/i.test(body))  problems.push("â€¢ Missing **Problem Statement / Background** section");
            if (!/Goals/i.test(body))              problems.push("â€¢ Missing **Goals / Outcomes** section");
            if (!/Proposed Solution/i.test(body))  problems.push("â€¢ Missing **Proposed Solution** section");

            console.log(`Detected ${problems.length} problems`);
            core.setOutput("author", author);
            core.setOutput("problems", JSON.stringify(problems));

            const failMsg = [
              "",
              `Howdy @${author},`,
              "",
              "The following issues were found in this ticket:",
              problems.join("\\n"),
              "",
              "Please edit the issue to include or expand the required sections above.",
              "",
              "_Until the ticket has passed acceptance checks, it cannot be triaged._",
            ].join("\\n");

            const passMsg = [
              `âœ… Thanks @${author}!`,
              "",
              "Your feature request meets the required sections and can now move forward to triage.",
            ].join("\\n");

            core.setOutput("fail_message", failMsg);
            core.setOutput("pass_message", passMsg);

      # 4ï¸âƒ£ Comment / failure
      - name: (4) Comment â€” failure
        if: ${{ steps.validate.outputs.problems != '[]' && env.QUIET != 'true' }}
        uses: ./.github/workflows/post-comment.yaml
        with:
          body: ${{ steps.validate.outputs.fail_message }}

      # 5ï¸âƒ£ Comment / success
      - name: (5) Comment â€” success
        if: ${{ steps.validate.outputs.problems == '[]' && env.QUIET != 'true' }}
        uses: ./.github/workflows/post-comment.yaml
        with:
          body: ${{ steps.validate.outputs.pass_message }}

      # 6ï¸âƒ£ Labels â€” failure
      - name: (6) Labels â€” add needs-more-info
        if: ${{ steps.validate.outputs.problems != '[]' }}
        uses: ./.github/workflows/manage-labels.yaml
        with:
          add: ${{ steps.init.outputs.labels_fail }}

      - name: (7) Labels â€” remove needs-triage on failure
        if: ${{ steps.validate.outputs.problems != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ðŸ·ï¸ Step 7 â€” Removing 'needs-triage' (failure)");
            const { github, context } = require('@actions/github');
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: "needs-triage",
              });
            } catch { console.log("Label not present; skipping"); }

      # 8ï¸âƒ£ Labels â€” success
      - name: (8) Labels â€” add needs-triage
        if: ${{ steps.validate.outputs.problems == '[]' }}
        uses: ./.github/workflows/manage-labels.yaml
        with:
          add: ${{ steps.init.outputs.labels_pass }}

      - name: (9) Labels â€” remove needs-more-info on success
        if: ${{ steps.validate.outputs.problems == '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ðŸ·ï¸ Step 9 â€” Removing 'needs-more-info' (success)");
            const { github, context } = require('@actions/github');
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: "needs-more-info",
              });
            } catch { console.log("Label not present; skipping"); }

      # ðŸ”Ÿ Assignments
      - name: (10) Assign author (failure)
        if: ${{ steps.validate.outputs.problems != '[]' }}
        uses: ./.github/workflows/manage-assignees.yaml
        with:
          action: add
          assignees: ${{ format('["{0}"]', steps.validate.outputs.author) }}

      - name: (11) Unassign author (success)
        if: ${{ steps.validate.outputs.problems == '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            console.log("ðŸ‘¤ Step 11 â€” Unassigning author (success)");
            const { github, context } = require('@actions/github');
            const author = `${{ steps.validate.outputs.author }}`;
            const { data: current } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
            });
            const assignees = current.assignees.map(a => a.login);
            if (assignees.includes(author)) {
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                assignees: [author],
              });
              console.log(`âœ… Removed ${author} from assignees`);
            } else {
              console.log("No removal needed â€” not assigned");
            }

      # 1ï¸âƒ£2ï¸âƒ£ Summaries
      - name: (12) Summary â€” failed validation
        if: ${{ steps.validate.outputs.problems != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { core } = require('@actions/github');
            const problems = JSON.parse(`${{ steps.validate.outputs.problems }}`);
            console.log("ðŸ“‹ Step 12 â€” Writing failure summary");
            await core.summary
              .addHeading("âŒ Feature Request Validation Failed")
              .addList(problems)
              .addQuote("Please update the ticket and rerun the validation.")
              .write();

      - name: (13) Summary â€” passed validation
        if: ${{ steps.validate.outputs.problems == '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { core } = require('@actions/github');
            const author = `${{ steps.validate.outputs.author }}`;
            console.log("ðŸ“‹ Step 13 â€” Writing success summary");
            await core.summary
              .addHeading("âœ… Feature Request Validation Passed")
              .addRaw(`@${author}'s ticket meets all section requirements.`)
              .write();

      # 1ï¸âƒ£4ï¸âƒ£ Echo problems output
      - name: (14) Output problems
        if: always()
        run: |
          echo "ðŸ“¤ Step 14 â€” Exporting problems output"
          echo "problems=${{ steps.validate.outputs.problems }}" >> "$GITHUB_OUTPUT"
